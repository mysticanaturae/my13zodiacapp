<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>13-Zodiak Astrologija ‚ú®</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./style.css">
  <script src="main.js" defer></script>

  <script>
   if ('serviceWorker' in navigator) {
     navigator.serviceWorker.register('./sw.js')
       .then(reg => console.log("Service Worker registered"))
       .catch(err => console.log("Service Worker registration failed:", err));
   }
  </script>
</head>

<body>
  <div id="zodiacApp">
    <h1>‚ú® 13-ZODIAK ASTROLOGIJA ‚ú®</h1>
    <p class="subtitle">Odkrij svojo resniƒçno kozmiƒçno identiteto & energijski podpis du≈°e</p>

    <div class="inputGroup">
      <input type="text" id="nameInput" placeholder="Ime">
      <input type="date" id="dobInput" placeholder="Datum rojstva">
      <input type="time" id="timeInput" placeholder="Ura rojstva">
      <input type="text" id="placeInput" placeholder="Kraj in dr≈æava rojstva">
      <button id="btnCompute">Freemium Izraƒçun</button>
      <button id="btnPremium">‚ú® Premium Napoved</button>
    </div>

    <div id="statusText"></div>
    <div id="snapshotBox"></div>
    <div id="signsRepeater"></div>
  </div>

  <script>
    // ============================
    // 13-ZODIAK SYSTEM
    // ============================
    const zodiac13 = ["Oven","Bik","Dvojƒçka","Rak","Lev","Devica","Tehtnica","≈†korpijon","Ophiuchus","Strelec","Kozorog","Vodnar","Ribi"];

    const houses13 = [
      {number:1, name:"Hi≈°a Sebstva", ruler:"Oven", description:"Osnova identitete, fiziƒçno telo, osebni izraz."},
      {number:2, name:"Hi≈°a Vrednosti", ruler:"Bik", description:"Finanƒçni in materialni viri, vrednote."},
      {number:3, name:"Hi≈°a Komunikacije", ruler:"Dvojƒçka", description:"Misli, komunikacija, lokalno okolje."},
      {number:4, name:"Hi≈°a Doma", ruler:"Rak", description:"Dru≈æina, notranji svet, ƒçustvena varnost."},
      {number:5, name:"Hi≈°a Kreativnosti", ruler:"Lev", description:"Ustvarjalnost, ljubezen, otroci."},
      {number:6, name:"Hi≈°a Dela", ruler:"Devica", description:"Rutina, zdravje, slu≈æba."},
      {number:7, name:"Hi≈°a Partnerstva", ruler:"Tehtnica", description:"Odnosi, partnerstva, kontrakti."},
      {number:8, name:"Hi≈°a Transformacije", ruler:"≈†korpijon", description:"Globoke spremembe, dedovanje, intimnost."},
      {number:9, name:"Hi≈°a Transparentnosti", ruler:"Ophiuchus", description:"Samospoznanje, samoozdravitev, globoke resnice."},
      {number:10, name:"Hi≈°a Potovanj in Filozofije", ruler:"Strelec", description:"Uƒçenje, ≈°irjenje obzorij, potovanja, filozofija."},
      {number:11, name:"Hi≈°a Karier", ruler:"Kozorog", description:"Poklic, ambicije, javni ugled."},
      {number:12, name:"Hi≈°a Prijateljstev", ruler:"Vodnar", description:"Prijatelji, skupnosti, vizije."},
      {number:13, name:"Hi≈°a Du≈°e in Karmiƒçnih Lekcij", ruler:"Ribi", description:"Karma, skrivnosti, razsvetljenje."}
    ];

    const zodiacImages = {
      "Oven":"https://static.wixstatic.com/media/7535eb_4686ee40d73541afb9116473eed4cf64~mv2.png",
      "Bik":"https://static.wixstatic.com/media/7535eb_51af61b776b3483b9776bb203f4dd949~mv2.png",
      "Dvojƒçka":"https://static.wixstatic.com/media/7535eb_38e1fd146cc64ed4b5c203b54ad3c3ef~mv2.png",
      "Rak":"https://static.wixstatic.com/media/7535eb_04c1dad8d7a54fe9ba73e43d4fb8c96c~mv2.png",
      "Lev":"https://static.wixstatic.com/media/7535eb_63ae5332c9bf47b1a17d2c4063edfa12~mv2.png",
      "Devica":"https://static.wixstatic.com/media/7535eb_a86a4eafaa274b77bc2df05b5e634930~mv2.png",
      "Tehtnica":"https://static.wixstatic.com/media/7535eb_81207ec70cae4e23aada067d793eb455~mv2.png",
      "≈†korpijon":"https://static.wixstatic.com/media/7535eb_0bb8888d2ef04fdfbb773d4108fb6eac~mv2.png",
      "Ophiuchus":"https://static.wixstatic.com/media/7535eb_8d4b7558ec1545d2a4825fe05a3d5850~mv2.png",
      "Strelec":"https://static.wixstatic.com/media/7535eb_1411795fb0764a09a023179c9eff21d0~mv2.png",
      "Kozorog":"https://static.wixstatic.com/media/7535eb_22eddfb8f65644019f99ec7f083e0b5e~mv2.png",
      "Vodnar":"https://static.wixstatic.com/media/7535eb_f8efc8ce37a64367b6bf8f74b7c8670f~mv2.png",
      "Ribi":"https://static.wixstatic.com/media/7535eb_89ce0c6de1324a7394193b0409c18dc1~mv2.png"
    };

    // ============================
    // Local Storage
    // ============================
    function saveUserData(userData){ localStorage.setItem('astroUser', JSON.stringify(userData)); }
    function loadUserData(){ const data = localStorage.getItem('astroUser'); return data ? JSON.parse(data) : null; }

    // ============================
    // Compose Snapshot
    // ============================
    function composeSnapshotText(userData) {
      const date = new Date(`${userData.dob}T${userData.time}`);
      const yearStart = new Date(date.getFullYear(),0,1);
      const dayOfYear = Math.floor((date-yearStart)/(1000*60*60*24));
      const sunIndex = Math.floor((dayOfYear % 364)/28);
      const sun = zodiac13[sunIndex];

      const moonCycle = 29.53;
      const moonIndex = Math.floor(((dayOfYear % moonCycle)/moonCycle)*13);
      const moon = zodiac13[moonIndex];

      const birthHour = date.getHours() + date.getMinutes()/60;
      const ascIndex = Math.floor((birthHour/24)*13);
      const asc = zodiac13[ascIndex];

      const housesAssigned = houses13.map((h,i)=>({
        ...h,
        sign: zodiac13[(ascIndex+i)%13]
      }));

      let text = `Izraƒçun za: ${userData.name}\nDatum: ${userData.dob}\nUra: ${userData.time}\nKraj: ${userData.place}\n\n`;
      text += `üåû Sonce: ${sun}\nüåô Luna: ${moon}\n‚¨ÜÔ∏è Ascendent: ${asc}\n\nHi≈°e:\n`;
      housesAssigned.forEach(h=>text+=`${h.number}. ${h.name} ‚Äî znak: ${h.sign} (vladar: ${h.ruler}) ‚Äî ${h.description}\n`);
      return {text,sun,moon,asc,housesAssigned};
    }

    // ============================
    // Render Zodiac Cards
    // ============================
    function renderZodiacCards(housesAssigned,level='free'){
      const container = document.getElementById('signsRepeater');
      container.innerHTML='';

      housesAssigned.forEach(h=>{
        const card = document.createElement('div');
        card.className='zodiacCard';
        if(h.sign==='Ophiuchus') card.classList.add('highlightOphiuchus');

        let imagesHTML = `<div class="imgContainer">
          <img class="rulerImage" src="${zodiacImages[h.ruler]}" alt="${h.ruler}">
        </div>`;
        if(level==='premium'){
          imagesHTML = `<div class="imgContainer">
            <img class="signImage" src="${zodiacImages[h.sign]}" alt="${h.sign}">
            <img class="rulerImage" src="${zodiacImages[h.ruler]}" alt="${h.ruler}">
          </div>`;
        }

        card.innerHTML = `
          <span class="houseName">${h.number}. ${h.name}</span><br>
          <span class="houseSign">Znak: ${h.sign}</span><br>
          <span class="houseRuler">Vladar: ${h.ruler}</span>
          ${imagesHTML}
          <div class="houseDescription">${h.description}</div>
        `;
        container.appendChild(card);
      });
    }

    // ============================
    // Generate Prediction
    // ============================
    async function generatePrediction(level,userData,computed){
      if(level==='free'){
        return `Danes za ${userData.name}: Sonce v ${computed.sun} vabi k jasnosti, Luna v ${computed.moon} podpira ƒçustveno preobrazbo, Ascendent v ${computed.asc} odpira vrata prilo≈ænostim.`;
      }
      try{
        const res = await fetch('/api/generateforecast',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({snapshot:{sun:computed.sun,moon:computed.moon,asc:computed.asc,houses:computed.housesAssigned,raw:computed.text,userData},premium:true})
        });
        const data = await res.json();
        if(data?.choices?.[0]?.message?.content) return data.choices[0].message.content;
        return demoPremiumText(userData,computed);
      }catch(e){return demoPremiumText(userData,computed);}
    }

    function demoPremiumText(userData,computed){
      let out=`üåü PREMIUM (demo) za ${userData.name}\nSonce: ${computed.sun}\nLuna: ${computed.moon}\nAsc: ${computed.asc}\n\nHi≈°e:\n`;
      computed.housesAssigned.forEach(h=>out+=`${h.number}. ${h.name} ‚Äî ${h.sign}: ${h.description}\n`);
      out+='\n(Opomba: za polno AI razlago pove≈æi /api/openai.)';
      return out;
    }

    // ============================
    // Event Listeners
    // ============================
    document.addEventListener('DOMContentLoaded',()=>{
      renderZodiacCards(houses13,'free');
    });

    document.getElementById('btnCompute').addEventListener('click',async()=>{
      const userData={name:document.getElementById('nameInput').value||'Anonim',dob:document.getElementById('dobInput').value,time:document.getElementById('timeInput').value||'00:00',place:document.getElementById('placeInput').value||''};
      if(!userData.dob){alert('Vnesi datum rojstva!'); return;}
      saveUserData(userData);
      const computed=composeSnapshotText(userData);
      renderZodiacCards(computed.housesAssigned,'free');
      const freeText=await generatePrediction('free',userData,computed);
      document.getElementById('snapshotBox').innerHTML=`<pre>${computed.text}</pre><pre>${freeText}</pre>`;
      document.getElementById('statusText').innerText='Freemium napoved pripravljena!';
    });

    document.getElementById('btnPremium').addEventListener('click',async()=>{
      const userData=loadUserData();
      if(!userData){alert('Najprej izraƒçunaj svoj snapshot!'); return;}
      document.getElementById('statusText').innerText='Generiram premium napoved...';
      const computed=composeSnapshotText(userData);
      renderZodiacCards(computed.housesAssigned,'premium');
      const premium=await generatePrediction('premium',userData,computed);
      document.getElementById('snapshotBox').innerHTML=`<pre>${computed.text}</pre><pre>${premium}</pre>`;
      document.getElementById('statusText').innerText='Premium napoved pripravljena!';
    });
  </script>
</body>
</html>