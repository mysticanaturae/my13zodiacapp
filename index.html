<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>13-Zodiak Astrologija ‚ú®</title>
  <link rel="manifest" href="./manifest.json">

  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">

  <!-- External CSS -->
  <link rel="stylesheet" href="./style.css">

  <!-- Main JS -->
  <script src="main.js" defer></script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
      .then(() => console.log("Service Worker registered"))
      .catch(err => console.log("Service Worker registration failed:", err));
    }
  </script>
</head>
<body>

  <div id="zodiacApp">

    <h1>‚ú® 13-ZODIAK ASTROLOGIJA ‚ú®</h1>
    <p class="subtitle">Odkrij svojo resniƒçno kozmiƒçno identiteto & energijski podpis du≈°e</p>

    <div class="inputGroup">
      <input type="text" id="nameInput" placeholder="Ime">
      <input type="date" id="dobInput" placeholder="Datum rojstva">
      <input type="time" id="timeInput" placeholder="Ura rojstva">
      <input type="text" id="placeInput" placeholder="Kraj in dr≈æava rojstva">
      <button id="btnCompute">Freemium Izraƒçun</button>
      <button id="btnPremium">‚ú® Premium Napoved</button>
    </div>

    <div id="statusText"></div>
    <div id="snapshotBox"></div>
    <div id="signsRepeater"></div>

  </div>

  <script src="main.js"></script>
  <script>
// Ob nalaganju strani
document.addEventListener('DOMContentLoaded', () => {
  const container = document.getElementById('signsRepeater');
  container.innerHTML = '';
  houses13.forEach(h => {
    const card = document.createElement('div');
    card.className = 'zodiacCard';
    card.innerHTML = `<strong>${h.number}. ${h.name}</strong><br>Znak: ${h.sign}<br>Vladar: ${h.ruler}`;
    container.appendChild(card);
  });
});

    /* =========================
       13-ZODIAK (Berg) CALCULATOR
       ========================= */

    const zodiac13 = ["Oven","Bik","Dvojƒçka","Rak","Lev","Devica","Tehtnica","≈†korpijon","Ophiuchus","Strelec","Kozorog","Vodnar","Ribi"];

    const bergIntervals = [
      {sign:"Oven", start:"04-19", end:"05-13"},
      {sign:"Bik", start:"05-14", end:"06-19"},
      {sign:"Dvojƒçka", start:"06-20", end:"07-20"},
      {sign:"Rak", start:"07-21", end:"08-09"},
      {sign:"Lev", start:"08-10", end:"09-15"},
      {sign:"Devica", start:"09-16", end:"10-30"},
      {sign:"Tehtnica", start:"10-31", end:"11-22"},
      {sign:"≈†korpijon", start:"11-23", end:"11-29"},
      {sign:"Ophiuchus", start:"11-30", end:"12-17"},
      {sign:"Strelec", start:"12-18", end:"01-18"},
      {sign:"Kozorog", start:"01-19", end:"02-15"},
      {sign:"Vodnar", start:"02-16", end:"03-11"},
      {sign:"Ribi", start:"03-12", end:"04-18"}
    ];

    const houses13 = [
      {number:1, name:"Hi≈°a Sebstva", ruler:"Oven", description:"Osnova identitete, fiziƒçno telo, osebni izraz."},
      {number:2, name:"Hi≈°a Vrednosti", ruler:"Bik", description:"Finanƒçni in materialni viri, vrednote."},
      {number:3, name:"Hi≈°a Komunikacije", ruler:"Dvojƒçka", description:"Misli, komunikacija, lokalno okolje."},
      {number:4, name:"Hi≈°a Doma", ruler:"Rak", description:"Dru≈æina, notranji svet, ƒçustvena varnost."},
      {number:5, name:"Hi≈°a Kreativnosti", ruler:"Lev", description:"Ustvarjalnost, ljubezen, otroci."},
      {number:6, name:"Hi≈°a Dela", ruler:"Devica", description:"Rutina, zdravje, slu≈æba."},
      {number:7, name:"Hi≈°a Partnerstva", ruler:"Tehtnica", description:"Odnosi, partnerstva, kontrakti."},
      {number:8, name:"Hi≈°a Transformacije", ruler:"≈†korpijon", description:"Globoke spremembe, dedovanje, intimnost."},
      {number:9, name:"Hi≈°a Transparentnosti", ruler:"Ophiuchus", description:"Samospoznanje, samoozdravitev, globoke resnice."},
      {number:10, name:"Hi≈°a Potovanj in Filozofije", ruler:"Strelec", description:"Raz≈°irjanje obzorij, uƒçenje, potovanja, filozofija."},
      {number:11, name:"Hi≈°a Karier", ruler:"Kozorog", description:"Poklic, ambicije, javni ugled."},
      {number:12, name:"Hi≈°a Prijateljstev", ruler:"Vodnar", description:"Skupnosti, prijatelji, dolgoroƒçni cilji."},
      {number:13, name:"Hi≈°a Du≈°e in Karmiƒçnih Lekcij", ruler:"Ribi", description:"Karma, skrivnosti, razsvetljenje, duhovna rast."}
    ];

    function formatMMDD(date){const m=(date.getMonth()+1).toString().padStart(2,'0');const d=date.getDate().toString().padStart(2,'0');return `${m}-${d}`;}
    function getBergSunSign(date){const mmdd=formatMMDD(date);for(const it of bergIntervals){const s=it.start,e=it.end;if(s<=e){if(mmdd>=s && mmdd<=e) return it.sign;}else{if(mmdd>=s || mmdd<=e) return it.sign;}}return "Neznano";}
    function toJulianDateUTC(date){const Y=date.getUTCFullYear();const M=date.getUTCMonth()+1;const D=date.getUTCDate()+(date.getUTCHours()/24)+(date.getUTCMinutes()/(24*60))+(date.getUTCSeconds()/(24*3600));let y=Y;let m=M;if(m<=2){y-=1;m+=12;}const A=Math.floor(y/100);const B=2-A+Math.floor(A/4);return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+D+B-1524.5;}
    function getApproxMoonSign(date){const jd=toJulianDateUTC(date);const synodicMonth=29.530588853;const age=((jd-2451550.1)%synodicMonth+synodicMonth)%synodicMonth;const sector=Math.floor(age/(synodicMonth/13));return zodiac13[sector%13];}
    function getBergAscendant(localDate){const hour=localDate.getHours();const minute=localDate.getMinutes();const second=localDate.getSeconds();const decimalHours=hour+minute/60+second/3600;const segmentLength=24/13;const idx=Math.floor(decimalHours/segmentLength)%13;return zodiac13[idx];}
    function assignHousesFromAsc(ascSign){const start=zodiac13.indexOf(ascSign);return houses13.map((h,i)=>({...h, sign:zodiac13[(start+i)%13]}));}
    function composeSnapshotText(userData){const birthDate=new Date(`${userData.dob}T${userData.time}`);const sun=getBergSunSign(birthDate);const moon=getApproxMoonSign(birthDate);const asc=getBergAscendant(birthDate);const housesAssigned=assignHousesFromAsc(asc);let text=`Izraƒçun za: ${userData.name}\nDatum: ${userData.dob}\nUra: ${userData.time}\nKraj: ${userData.place}\n\n`;text+=`Sonce: ${sun}\nLuna (pribli≈æno): ${moon}\nAscendent (Berg linear): ${asc}\n\n`;text+=`ƒåe si premium, dobi≈° razpreditev vseh 13 hi≈° in podrobno razlago.\n`;return { text, sun, moon, asc, housesAssigned };}

    function buildPremiumPrompt(userData, computed){
      const { name, dob, time, place } = userData;
      const { sun, moon, asc, housesAssigned } = computed;
      const houseLines = housesAssigned.map(h => `${h.number}. ${h.name} ‚Äî znak: ${h.sign} (vladar: ${h.ruler}) ‚Äî ${h.description}`).join('\n');
      return `Ustvari globoko, personalizirano astrolo≈°ko razlago za ${name}.\nRojstni podatki: ${dob} ob ${time}, kraj: ${place}.\nSistem: 13-zodiak Berg, Ophiuchus je 9. znak.\nPolo≈æaji:\n- Sonce: ${sun}\n- Luna: ${moon}\n- Ascendent: ${asc}\n\nHi≈°e:\n${houseLines}\n\nProsimo za kratko 1-odstavek razlage, eno praktiƒçno nalogo na hi≈°o, eno afirmacijo na konec.\nDol≈æina do 900 znakov, ton: mistiƒçen, empatiƒçen, transformacijski.`;
    }

    async function generatePrediction(level, userData, computed){
      if(level==='free'){
        return `Danes za ${userData.name}: Sonce v ${computed.sun} vabi k jasnosti, Luna v ${computed.moon} podpira ƒçustveno preobrazbo, Ascendent v ${computed.asc} odpira vrata prilo≈ænostim.`;
      } else {
        const prompt = buildPremiumPrompt(userData, computed);
        try {
         const res = await fetch('/api/generateforecast',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({prompt,max_tokens:1200})
          });
          if(!res.ok) return demoPremiumText(userData,computed);
          const json = await res.json();
          return json.text || demoPremiumText(userData,computed);
        } catch(e){
          console.warn('Backend call failed',e);
          return demoPremiumText(userData,computed);
        }
      }
    }

    function demoPremiumText(userData,computed){
      const { sun, moon, asc, housesAssigned } = computed;
      let out = `üåü PREMIUM (demo) za ${userData.name}\nSonce: ${sun}\nLuna: ${moon}\nAsc: ${asc}\n\nHi≈°e (kratek pregled):\n`;
      housesAssigned.forEach(h=>out+=`${h.number}. ${h.name} ‚Äî ${h.sign}: ${h.description}\n`);
      out += `\n(Opomba: za polno AI razlago pove≈æi /api/openai.)`;
      return out;
    }

    function renderZodiacCards(housesAssigned){
      const container=document.getElementById('signsRepeater');
      container.innerHTML='';
      housesAssigned.forEach(h=>{
        const card=document.createElement('div');
        card.className='zodiacCard';
        card.innerHTML=`<strong>${h.number}. ${h.name}</strong><br>Znak: ${h.sign}<br>Vladar: ${h.ruler}`;
        container.appendChild(card);
      });
    }

    function saveUserData(userData){ localStorage.setItem('astroUser',JSON.stringify(userData)); }
    function loadUserData(){ const d=localStorage.getItem('astroUser'); return d?JSON.parse(d):null; }

    // Event listeners
    document.getElementById('btnCompute').addEventListener('click',async()=>{
      const userData={
        name: document.getElementById('nameInput').value || 'Anonim',
        dob: document.getElementById('dobInput').value,
        time: document.getElementById('timeInput').value || '00:00',
        place: document.getElementById('placeInput').value || ''
      };
      saveUserData(userData);
      const computed=composeSnapshotText(userData);
      document.getElementById('snapshotBox').innerText=computed.text;
      document.getElementById('statusText').innerText="Freemium snapshot izraƒçunan!";
      const freeText=await generatePrediction('free',userData,computed);
      document.getElementById('snapshotBox').innerText+=`\n\n${freeText}`;
    });

    document.getElementById('btnPremium').addEventListener('click',async()=>{
      const userData=loadUserData();
      if(!userData){ alert('Najprej izraƒçunaj svoj snapshot!'); return; }
      document.getElementById('statusText').innerText="Generiram premium napoved...";
      const computed=composeSnapshotText(userData);
      renderZodiacCards(computed.housesAssigned);
      const premium=await generatePrediction('premium',userData,computed);
      document.getElementById('snapshotBox').innerText=premium;
      document.getElementById('statusText').innerText="Premium napoved pripravljena!";
    });
  </script>

</body>
</html>
